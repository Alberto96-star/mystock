{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Registrar Orden de Venta{% endblock title %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="text-center text-dark">Registrar Nueva Orden de Venta</h2>
            <p class="lead text-center text-muted">Completa los detalles para crear una nueva orden de venta para un cliente.</p>
        </div>
    </div>

    {# Mensajes de Django #}
    {% if messages %}
        <div class="row mb-4">
            <div class="col-12">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-green text-white">
            <h5 class="mb-0">Datos de la Orden</h5>
        </div>
        <div class="card-body">
            <form method="post" id="ordenForm">
                {% csrf_token %}
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="id_cliente" class="form-label">Cliente <span class="text-danger">*</span></label>
                        <select class="form-select" id="id_cliente" name="cliente" required>
                            <option value="">Selecciona un cliente</option>
                            {% for cli in clientes %}
                                <option value="{{ cli.id }}">{{ cli.nombre_comercial }}</option>
                            {% endfor %}
                        </select>
                        <!--boton para el modal crear cliente-->
                        <button type="button" class="btn btn-outline-green m-2" data-bs-toggle="modal" data-bs-target="#modalCrearCliente">Crear clientes</button>
                    </div>
                    <div class="col-md-3">
                        <label for="id_fecha_orden" class="form-label">Fecha de Orden <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="id_fecha_orden" name="fecha_orden" value="{{ fecha_actual|date:'Y-m-d' }}" required>
                    </div>
                    <div class="col-md-3">
                        <label for="id_fecha_entrega" class="form-label">Fecha de Entrega <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="id_fecha_entrega" name="fecha_entrega" required>
                    </div>
                    <div class="col-md-6">
                        <label for="id_metodo_pago" class="form-label">Método de Pago</label>
                        <select class="form-select" id="id_metodo_pago" name="metodo_pago">
                            {% for key, value in metodos_pago_choices %}
                                <option value="{{ key }}" {% if key == orden.metodo_pago %}selected{% endif %}>{{ value }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="id_descuento_general" class="form-label">Descuento General (€)</label>
                        <input type="number" step="0.01" class="form-control" id="id_descuento_general" name="descuento_general" value="0.00" min="0">
                    </div>
                    <div class="col-12">
                        <label for="id_notas_orden" class="form-label">Notas</label>
                        <textarea class="form-control" id="id_notas_orden" name="notas" rows="1"></textarea>
                    </div>
                </div>

                <hr class="my-4">

                <h5 class="mb-3">Detalles de Productos</h5>
                <div id="product-details-container-orden">
                    {# Los productos se añadirán aquí dinámicamente con JavaScript #}
                    <div class="row g-3 align-items-end mb-3 product-row-orden border rounded p-3 bg-light">
                        <div class="col-md-2">
                            <label class="form-label">Categorias</label>
                            <select class="form-select me-2" id="categoria-filter">
                                <option value="">Filtrar categorías</option>
                                {% for cat in categorias %}
                                <option value="{{ cat.id }}">
                                    {{ cat.nombre_categoria }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="product-select-orden-0" class="form-label">Producto - <small id="stock-orden-0" class="text-muted">Stock disponible: 0</small><span class="text-danger"> *</span></label>
                            <select class="form-select product-select-orden" id="product-select-orden-0" name="producto_id" required>
                                <option value="">Selecciona un producto</option>
                                {% for prod in productos %}
                                    {% with inventario=prod.inventarios.first %}
                                        <option value="{{ prod.id }}" data-precio="{{ prod.precio_venta }}" data-categoria="{{ prod.categoria.id }}" cantActual="{{ inventario.cantidad_actual|default:0 }}" cantReservada="{{ inventario.cantidad_reservada|default:0 }}">{{ prod.nombre }} </option>
                                    {% endwith %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-1">
                            <label for="cantidad-orden-0" class="form-label">Cantidad <span class="text-danger">*</span></label>
                            <input type="number" class="form-control cantidad-input-orden" id="cantidad-orden-0" name="cantidad" value="1" min="1" required>
                        </div>
                        <div class="col-md-2">
                            <label for="precio-unitario-orden-0" class="form-label">Precio Unitario (€) <span class="text-danger">*</span></label>
                            <input type="number" step="0.01" class="form-control precio-unitario-input-orden" id="precio-unitario-orden-0" name="precio_unitario" value="0.00" min="0" required>
                        </div>
                        <div class="col-md-2">
                            <label for="descuento-linea-orden-0" class="form-label">Descuento (€)</label>
                            <input type="number" step="0.01" class="form-control descuento-linea-input-orden" id="descuento-linea-orden-0" name="descuento_linea" value="0.00" min="0">
                        </div>
                        <div class="col-md-2">
                            <label for="id_igic_porcentaje" class="form-label">Porcentaje de IGIC (%) <span class="text-danger">*</span></label>
                            <select class="form-select" id="id_igic_porcentaje" name="igic_porcentaje" required>
                                <option value="">Seleccionar porcentaje de IGIC...</option>
                                <option value="0.00" selected>0% - Exento</option>
                                <option value="3.00">3% - Tipo reducido</option>
                                <option value="7.00">7% - Tipo general</option>
                            </select>
                        </div>
                        <div class="col-md-1 d-flex justify-content-center">
                            <button type="button" class="btn btn-danger remove-product-btn-orden" style="display: none;">
                                Eliminar
                            </button>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-end mb-4">
                    <button type="button" class="btn btn-outline-secondary" id="add-product-btn-orden">
                        <i class="bi bi-plus-circle me-1"></i> Añadir Otro Producto
                    </button>
                </div>

                <div class="d-flex justify-content-end">
                    <a href="{% url 'listado_ordenes_venta' %}" class="btn btn-outline-secondary me-2">Cancelar</a>
                    <button type="submit" class="btn btn-outline-teal">Registrar Orden de Venta</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- Modal para crear cliente -->
<div class="modal fade" id="modalCrearCliente" tabindex="-1" aria-labelledby="modalCrearClienteLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="formCrearCliente" action="{% url 'registro_cliente' %}" method="POST">
                {% csrf_token %}
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="modalCrearClienteLabel">
                        <i class="fas fa-user-plus"></i> Crear Cliente
                    </h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <!-- Información básica -->
                        <div class="col-md-8">
                            <label for="modalNombreComercial" class="form-label">Nombre Comercial:</label>
                            <input type="text" name="nombreComercial" class="form-control" id="modalNombreComercial"
                                placeholder="Nombre de la empresa o persona de facturación" required>
                        </div>
                        <div class="col-md-4">
                            <label for="modalCif" class="form-label">CIF:</label>
                            <input type="text" name="cif" class="form-control" id="modalCif" 
                                placeholder="CIF o NIF empresarial" required>
                        </div>
                        
                        <!-- Teléfonos y email -->
                        <div class="col-md-4">
                            <label for="modalTelefonoOficina" class="form-label">Teléfono oficina:</label>
                            <input type="tel" name="telefonoOficina" class="form-control" id="modalTelefonoOficina"
                                placeholder="Número principal" required>
                        </div>
                        <div class="col-md-4">
                            <label for="modalTelefonoAdicional" class="form-label">Teléfono segundario:</label>
                            <input type="tel" name="telefonoSegundario" class="form-control" id="modalTelefonoAdicional"
                                placeholder="Número segundario">
                        </div>
                        <div class="col-md-4">
                            <label for="modalUsername" class="form-label">Código empleado:</label>
                            <input type="text" name="username" class="form-control" id="modalUsername">
                        </div>
                        
                        <!-- Email -->
                        <div class="col-12">
                            <label for="modalEmail" class="form-label">Email:</label>
                            <input type="email" name="email" class="form-control" id="modalEmail" 
                                placeholder="info@correo.com">
                        </div>
                        
                        <!-- Dirección fiscal -->
                        <div class="col-12">
                            <h6 class="text-muted mt-3 mb-2">
                                <i class="fas fa-building"></i> Dirección Fiscal
                            </h6>
                        </div>
                        <div class="col-md-8">
                            <label for="modalDireccionFiscal" class="form-label">Dirección fiscal:</label>
                            <input type="text" name="direccionFiscal" class="form-control" id="modalDireccionFiscal" required>
                        </div>
                        <div class="col-md-4">
                            <label for="modalCiudadFiscal" class="form-label">Ciudad fiscal:</label>
                            <input type="text" name="ciudadFiscal" class="form-control" id="modalCiudadFiscal" required>
                        </div>
                        <div class="col-md-4">
                            <label for="modalCodigoPostalFiscal" class="form-label">Código postal fiscal:</label>
                            <input type="number" name="codigoPostalFiscal" class="form-control" id="modalCodigoPostalFiscal" required>
                        </div>
                        
                        <!-- Dirección de entrega -->
                        <div class="col-12">
                            <h6 class="text-muted mt-3 mb-2">
                                <i class="fas fa-truck"></i> Dirección de Entrega (Opcional)
                            </h6>
                        </div>
                        <div class="col-md-8">
                            <label for="modalDireccionEntrega" class="form-label">Dirección entrega:</label>
                            <input type="text" name="direccionEntrega" class="form-control" id="modalDireccionEntrega">
                        </div>
                        <div class="col-md-4">
                            <label for="modalCiudadEntrega" class="form-label">Ciudad entrega:</label>
                            <input type="text" name="ciudadEntrega" class="form-control" id="modalCiudadEntrega">
                        </div>
                        <div class="col-md-4">
                            <label for="modalCodigoPostalEntrega" class="form-label">Código postal entrega:</label>
                            <input type="number" name="codigoPostalEntrega" class="form-control" id="modalCodigoPostalEntrega">
                        </div>
                        
                        <!-- Estado del cliente -->
                        <div class="col-12">
                            <div class="form-check form-switch">
                                <input class="form-check-input" name="estadoCliente" type="checkbox" 
                                    role="switch" id="modalEstadoCliente" checked>
                                <label class="form-check-label" for="modalEstadoCliente">
                                    Cliente Activo
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-outline-teal">
                        <i class="fas fa-save"></i> Crear Cliente
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script src="{% static 'pedidos/js/registroOrdenVenta.js' %}"></script>
<script src="{% static 'pedidos/js/modalCrearCliente.js' %}"></script>
{% endblock extra_js %}