{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Orden {{ orden.numero_orden }}{% endblock title %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="text-center text-dark">Detalle de la Orden de Venta: <span class="text-color-green">{{ orden.numero_orden }}</span></h2>
            <p class="lead text-center text-muted">Información completa y gestión de los productos asociados a esta orden.</p>
        </div>
    </div>

    {# Mensajes de Django #}
    {% if messages %}
        <div class="row mb-4">
            <div class="col-12">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}

    {# Información General de la Orden #}
    <div class="card shadow-sm mb-4">
        <form method="POST" action="{% url 'eliminar_orden_venta' orden.id %}">
            {% csrf_token %}
            <div class="card-header bg-green text-white d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                <h5 class="mb-2 mb-md-0">Datos de la Orden</h5>
                <div class="d-flex flex-column flex-sm-row gap-2">
                    <a href="{% url 'listado_ordenes_venta' %}" class="btn btn-light btn-sm">
                        <i class="bi bi-arrow-left-circle me-1"></i> Volver al Listado
                    </a>
                    {% if orden.estado == 'cancelado' %}
                    <button type="submit" class="btn btn-danger btn-sm" data-bs-toggle="modal" onclick="return confirm('¿Estás seguro de que quieres eliminar esta orden por completo?');">
                        <i class="bi bi-trash me-1"></i> Eliminar Orden
                    </button>
                    {% else %}
                    <button type="button" class="btn btn-outline-secondary btn-sm" disabled title="Solo se pueden eliminar ordenes en estado Cancelado">
                        <i class="bi bi-trash me-1"></i> Eliminar Orden
                    </button>
                    {% endif %}
                </div>
            </div>
        </form>
        <div class="card-body">
            <div class="row">
                <div class="col-lg-6 mb-3 mb-lg-0">
                    <p><strong>Cliente:</strong> {{ orden.cliente.nombre_comercial }}</p>
                    <p><strong>Fecha de Orden:</strong> {{ orden.fecha_orden|date:"d M, Y" }}</p>
                    <p><strong>Fecha de Entrega:</strong> {{ orden.fecha_entrega|date:"d M, Y" }}</p>
                    <p><strong>Método de Pago:</strong> {{ orden.metodo_pago }}</p>
                    <p><strong>Dirección de Entrega:</strong> {{ orden.cliente.direccion_entrega }} - {{ orden.cliente.ciudad_entrega }}</p>
                    <p><strong>Código Postal de Entrega:</strong> {{ orden.cliente.codigo_postal_entrega }}</p>
                </div>
                <div class="col-lg-6">
                    <p><strong>Subtotal:</strong> {{ orden.subtotal|intcomma }} €</p>
                    <p><strong>Descuento General:</strong> {{ orden.descuento|intcomma }} €</p>
                    <p><strong>Impuestos (IGIC):</strong> {{ orden.impuestos|intcomma }} €</p>
                    <p class="h5"><strong>Total:</strong> <span class="text-primary">{{ orden.total|intcomma }} €</span></p>
                    <p><strong>Empleado Creador:</strong> {{ orden.empleado_creador.first_name|default:orden.empleado_creador.username }}</p>
                    <p><strong>Notas:</strong> {{ orden.notas|default:"N/A" }}</p>
                </div>
            </div>
            <hr>
            {# Actualizar Estado #}
            <form method="post" action="{% url 'detalle_orden_venta' orden.id %}" class="row g-3 align-items-end">
                {% csrf_token %}
                <input type="hidden" name="accion" value="actualizar_estado">
                <div class="col-md-4 col-lg-3">
                    <label for="id_estado_orden" class="form-label">Actualizar Estado:</label>
                    <select class="form-select" id="id_estado_orden" name="estado">
                        {% for key, value in estados %}
                            <option value="{{ key }}" {% if key == orden.estado %}selected{% endif %}>{{ value }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-auto">
                    <button type="submit" class="btn btn-outline-warning text-dark">Actualizar Estado</button>
                </div>
            </form>
        </div>
    </div>

    {# Editar Información General #}
    {% if puede_editar %}
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-secondary-subtle text-dark">
            <h5 class="mb-0">Editar Información General</h5>
        </div>
        <div class="card-body">
            <form method="post" action="{% url 'detalle_orden_venta' orden.id %}">
                {% csrf_token %}
                <input type="hidden" name="accion" value="actualizar_informacion_general">
                
                <div class="row g-3">
                    <div class="col-md-6 col-lg-4">
                        <label for="id_descuento_general" class="form-label">Descuento General (€)</label>
                        <input type="number" step="0.01" class="form-control" id="id_descuento_general"
                            name="descuento_general" value="{{ orden.descuento }}" min="0" max="{{ orden.subtotal }}">
                        <div class="form-text">Máximo: {{ orden.subtotal|intcomma }} €</div>
                    </div>
                    <div class="col-md-6 col-lg-4">
                        <label for="id_metodo_pago" class="form-label">Método de Pago</label>
                        <select class="form-select" id="id_metodo_pago" name="metodo_pago">
                            {% for key, value in metodos_pago_choices %}
                                <option value="{{ key }}" {% if key == orden.metodo_pago %}selected{% endif %}>{{ value }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-6 col-lg-4">
                        <label for="id_fecha_entrega" class="form-label">Fecha de Entrega</label>
                        <input type="date" class="form-control" id="id_fecha_entrega" 
                            name="fecha_entrega" value="{{ orden.fecha_entrega|date:'Y-m-d' }}" 
                            min="{{ orden.fecha_orden|date:'Y-m-d' }}">
                    </div>
                    
                    <div class="col-12">
                        <label for="id_notas" class="form-label">Notas</label>
                        <textarea class="form-control" id="id_notas" name="notas" rows="1" 
                                placeholder="Notas adicionales sobre la orden...">{{ orden.notas }}</textarea>
                    </div>
                    
                    <div class="col-12">
                        <button type="submit" class="btn btn-outline-secondary">
                            <i class="bi bi-pencil-square me-1"></i> Actualizar Información
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info" role="alert">
        <i class="bi bi-info-circle me-2"></i>
        Esta orden no se puede editar porque está en estado "{{ orden.get_estado_display }}".
    </div>
    {% endif %}

    {# Detalles de Productos de la Orden #}
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-green text-white">
            <h5 class="mb-0">Productos en esta Orden</h5>
        </div>
        <div class="card-body">
            {% if detalles %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th scope="col">Producto</th>
                                <th scope="col" class="d-none d-md-table-cell">Cantidad</th>
                                <th scope="col" class="d-none d-lg-table-cell">Precio Unit.</th>
                                <th scope="col" class="d-none d-lg-table-cell">Desc. Línea</th>
                                <th scope="col" class="d-none d-md-table-cell">IGIC %</th>
                                <th scope="col" class="d-none d-lg-table-cell">IGIC €</th>
                                <th scope="col">Subtotal</th>
                                <th scope="col">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for detalle in detalles %}
                                <tr>
                                    <td>
                                        <div class="fw-bold">{{ detalle.producto.nombre }}</div>
                                        <div class="d-md-none text-muted small">
                                            Cant: {{ detalle.cantidad|intcomma }} | 
                                            IGIC: {{ detalle.igic_porcentaje }}%
                                        </div>
                                    </td>
                                    <td class="d-none d-md-table-cell">{{ detalle.cantidad|intcomma }}</td>
                                    <td class="d-none d-lg-table-cell">{{ detalle.precio_unitario|intcomma }} €</td>
                                    <td class="d-none d-lg-table-cell">{{ detalle.descuento_linea|intcomma }} €</td>
                                    <td class="d-none d-md-table-cell">{{ detalle.igic_porcentaje }}%</td>
                                    <td class="d-none d-lg-table-cell">{{ detalle.igic_importe|intcomma }} €</td>
                                    <td><strong>{{ detalle.subtotal|intcomma }} €</strong></td>
                                    <td>
                                        {% if puede_editar %}
                                            <form action="{% url 'eliminar_producto_orden_venta' detalle.id %}" method="post" class="d-inline">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-danger btn-sm" title="Eliminar Producto" 
                                                        onclick="return confirm('¿Estás seguro de que quieres eliminar este producto de la orden?');">
                                                    Eliminar
                                                </button>
                                            </form>
                                        {% else %}
                                            <span class="text-muted small">No editable</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info" role="alert">
                    Esta orden no tiene productos asociados aún.
                </div>
            {% endif %}
        </div>
    </div>

    {# Añadir Nuevo Producto a la Orden #}
    {% if puede_editar %}
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">Añadir Nuevo Producto a la Orden</h5>
        </div>
        <div class="card-body">
            <form method="post" action="{% url 'agregar_producto_orden_venta' orden.id %}">
                {% csrf_token %}
                <div class="row g-3">
                    <div class="col-md-2">
                        <label class="form-label">Categorias</label>
                        <select class="form-select me-2" id="categoria-filter">
                            <option value="">Filtrar categorías</option>
                            {% for cat in categorias %}
                            <option value="{{ cat.id }}">
                                {{ cat.nombre_categoria }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <label for="id_producto_orden" class="form-label">Producto - <small id="stock-orden-0" class="text-muted">Stock disponible: 0</small><span class="text-danger"> *</span></label>
                        <select class="form-select" id="id_producto_orden" name="producto" required>
                            <option value="">Selecciona un producto</option>
                            {% for prod in productos %}
                                {% with inventario=prod.inventarios.first %}
                                    <option value="{{ prod.id }}" data-precio="{{ prod.precio_venta|default:'0.00' }}" cantActual="{{ inventario.cantidad_actual }}" cantReservada="{{ inventario.cantidad_reservada }}" data-categoria="{{ prod.categoria.id }}">
                                        {{ prod.nombre }}
                                    </option>
                                {% endwith %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-6 col-md-3 col-lg-2">
                        <label for="id_cantidad_orden" class="form-label">Cantidad <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="id_cantidad_orden" name="cantidad" value="1" min="1" required>
                    </div>
                    <div class="col-6 col-md-3 col-lg-2">
                        <label for="id_precio_unitario_orden" class="form-label">Precio Unit. (€) <span class="text-danger">*</span></label>
                        <input type="number" step="0.01" class="form-control" id="id_precio_unitario_orden" 
                            name="precio_unitario" value="0.00" min="0" required>
                    </div>
                    <div class="col-6 col-md-4 col-lg-2">
                        <label for="id_descuento_linea_orden" class="form-label">Desc. Línea (€)</label>
                        <input type="number" step="0.01" class="form-control" id="id_descuento_linea_orden" 
                            name="descuento_linea" value="0.00" min="0">
                    </div>
                    <div class="col-6 col-md-4 col-lg-2">
                        <label for="id_igic_porcentaje" class="form-label">IGIC (%) <span class="text-danger">*</span></label>
                        <select class="form-select" id="id_igic_porcentaje" name="igic_porcentaje" required>
                            <option value="">Seleccionar IGIC...</option>
                            <option value="0.00" selected>0% - Exento</option>
                            <option value="3.00">3% - Reducido</option>
                            <option value="7.00">7% - General</option>
                        </select>
                    </div>
                    <div class="col-2 col-md-4 col-lg-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-outline-teal w-100 w-lg-auto">
                            <i class="bi bi-plus-circle me-1"></i> Añadir Producto
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
</div>
{% endblock content %}

{% block extra_js %}
<script src="{% static 'pedidos/js/detalleOrdenVenta.js' %}"></script>
{% endblock extra_js %}